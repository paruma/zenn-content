---
title: "3NFの定義の2NFであるという条件は冗長である"
emoji: "🤖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["データベース"]
published: false
---

あるリレーションスキーマが3NFであるとは、次の(1), (2)を満たすことと定義されることが多い。

(1) 2NFである（任意の非キー属性が任意のキー候補に完全関数従属する）
(2) 任意の非キー属性が任意の候補キーに非推移的に関数従属する

実は(1)は冗長である。本記事では、(1)が冗長であること、すなわち「(2)ならば(1)」であることを示す。

# tl;dr
「(2)ならば(1)」を示すために、その対偶「(1)でないならば(2)でない」を示す。
ここでは例を用いて「(1)でないならば(2)でない」こと、すなわち「2NFではないならば、ある非キー属性がある候補キーに推移的に関数従属」ことをざっくりと説明する。

学生の所属する部活動に関するリレーションスキーマを考える。属性は学籍番号・学生氏名・部活動の3つとする。
このリレーションスキーマには、「{学籍番号}→{学生氏名}」いう関数従属性がある。
同姓同名の可能性を考え、「{学生氏名}→{学籍番号}」という関数従属性はないとする。
また兼部の可能性を考え、「{学籍番号}→{部活動}」という関数従属性もないとする。

このリレーションスキーマは2NFではない。
なぜなら、関数従属性「{学籍番号, 部活動}→{学生氏名}」は部分関数従属だからである。
（{学籍番号, 部活動}はキー候補、学生氏名は非キー属性で、「{学籍番号}→{学生氏名}」という関数従属があることに注意）

「2NFでない」ことから「ある非キー属性がある候補キーに推移的に関数従属する」も言える。
この例でいうと、部分関数従属性「{学籍番号, 部活動}→{学生氏名}」は
「{学籍番号, 部活動}→{学籍番号}→{学生氏名}」
という推移的な関数従属と見れるからである。


この記事では、まずリレーションスキーマや関数従属性、2NF、3NFなどを定式化する。そして「2NFではないならば、ある非キー属性がある候補キーに推移的に関数従属」こと、すなわち「3NFの定義の2NFであるという条件は冗長である」ことを証明する。


# 準備: 集合論
## 部分集合
集合 $A$ が集合 $B$ の部分集合であることを $A \subseteq B$、集合 $A$ が集合 $B$ の真部分集合であることを $A \subsetneq B$ と書くことにする。

## べき集合
集合 $X$ に対して、$X$ の部分集合全体の集合を $X$ の**べき集合**といい、$\mathcal{P}(X)$ と表す。

:::message
$X$ のべき集合は $2^X$ と書くこともあるが、本記事では $X$ の部分が複雑な場合があるので $\mathcal{P}(X)$ と書くことにする。
:::


## 写像の制限
$X, Y$ を集合とする。写像 $f\colon X\to Y$ と部分集合 $A \subseteq X$ に対して、写像 $f|_A\colon A \to Y,\ f|_A(x) = f(x)$ を写像 $f$ の $A$ への**制限**という。

## 直積
$X$ を集合とし、$(D(x))_{x\in X}$ を集合族とする。集合族 $(D(x))_{x\in X}$ の**直積** $\prod_{x\in X} D(x)$ を次のように定義する。
$$\prod_{x\in X} D(x) = \left\{t\colon X \to \bigcup_{x\in X} D(x) \mid \text{任意の $x\in X$ に対して $t(x) \in D(x)$}\right\}$$

# テーブル
例として、以下のテーブルを考える。

| 社員ID | 社員氏名 | 部署コード | 部署名 |
| ------ | -------- | ---------- | ------ |
| 1      | 社員A    | 2          | 部署Y  |
| 2      | 社員B    | 2          | 部署Y  |
| 3      | 社員C    | 1          | 部署X  |

テーブルには「社員ID」のような属性がある。属性全体の集合を$X$としよう。
$X=\{\text{社員ID}, \text{社員氏名},\text{部署コード},\text{部署名}\}$ である。

各属性には型がある。例えば、社員IDは整数型、社員氏名は文字列型である。
各属性 $x\in X$ に対して、属性 $x$ の取りうる値の集合 $D(x)$ が考えられる。
例えば、$D(\text{社員ID})$ は整数の集合、$D(\text{社員氏名})$ は文字列の集合、のように考えられる。

テーブルには行がいくつかある。1行目を見ると、$(1, \text{社員A} , 2 , \text{部署Y})$がある。ここでは行のことをタプルと呼ぶことにする。
タプルは写像 $X \to \bigcup_{x\in X} D(x)$ であると思うことができる。
1行目のタプル $t\colon X \to \bigcup_{x\in X} D(x)$ は、
$t(\text{社員ID})=1,\ t(\text{社員氏名})=\text{社員A},\ t(\text{部署コード})=2,\ t(\text{部署名})=\text{部署Y}$
である。
直積 $\prod_{x\in X} D(x)$ を用いると、$t\in \prod_{x\in X} D(x)$である。
テーブルはタプルの集合である。つまり、テーブルは $\prod_{x\in X} D(x)$ の部分集合である。

以上の話を踏まえて、テーブルを定式化する。


---
**定義1 (テーブル)**
$X$ を集合とし、$D = (D(x))_{x\in X}$ を集合族とする。$R \subseteq \prod_{x\in X} D(x)$ とする。
このとき、3つ組 $\langle X, D, R \rangle$ を**テーブル**と呼ぶ。単に $R$ のことをテーブルと呼ぶこともある。テーブルは**リレーション**とも呼ばれる。

$x\in X$ を**属性**と呼ぶ。また、$x\in X$ に対して、$D(x)$ を属性 $x$ の**ドメイン**と呼ぶ。
$t\in R$ を テーブル $R$ の**タプル**と呼ぶ。つまり、$R$ はタプルの集合である。

タプル $t\in R$ について、$t\in \prod_{x\in X} D(x)$ を満たす。さらに、$t$ は写像 $t: X \to \bigcup_{x\in X} D(x)$ である。

タプル $t\in R$、$A\in \mathcal{P}(X)$ に対して、$t[A] = t|_A$ と表記する。
ただし、$t|_A$ は写像 $t$ の $A$ への制限であり、$t\colon X \to \bigcup_{x\in X} D(x)$ に対して、$t|_A\colon A \to \bigcup_{x\in X} D(x),\ t|_A(x) = t(x)$ 
と定義される。

---

$t[A] = t|_A$ という表記について、先程の例
$t\colon X \to \bigcup_{x\in X} D(x)$
$t(\text{社員ID})=1,\ t(\text{社員氏名})=\text{社員A},\ t(\text{部署コード})=2,\ t(\text{部署名})=\text{部署Y}$
で確認する。
$A = \{\text{社員ID}, \text{社員氏名}\}$ としたとき、
$t|_A \colon A \to \bigcup_{x\in X} D(x)$
$t|_A(\text{社員ID})=1,\ t|_A(\text{社員氏名})=\text{社員A}$
である。
よって、$t[A](=t|_A)$ は タプル $t$ から $A$ にない属性の値を捨てて $A$ にある属性のみを残した、$t$ の部分タプルである。


# リレーションスキーマ
すべての $\prod_{x\in X} D(x)$ の部分集合（テーブル）が現実的なテーブルとは限らない。
例えば、以下のような「1つの部署コードに対応する部署名が複数ある」テーブルは普通現れない。
（以下のテーブルでは、部署コード4に対して、部署Wと部署Vの2種類が対応してしまっている）

| 社員ID | 社員氏名 | 部署コード | 部署名 |
| ------ | -------- | ---------- | ------ |
| 4      | 社員D    | 3          | 部署Z  |
| 5      | 社員E    | 4          | 部署W  |
| 6      | 社員F    | 4          | 部署V  |

ここで、ありえるテーブル全体の集合として、$\prod_{x\in X} D(x)$の部分集合の集合 $\mathcal{R} \subseteq \mathcal{P}(\prod_{x\in X} D(x))$ を考える。
テーブル $R \in \mathcal{P}(\prod_{x\in X} D(x))$ に対して、
$R\in \mathcal{R}$ であればありえるテーブル、$R \notin \mathcal{R}$ であればありえないテーブルと解釈する。

以上の話を踏まえて、リレーションスキーマを定義する。

---
**定義2 (リレーションスキーマ)**
$X$ を集合とし、$D = (D(x))_{x\in X}$ を集合族とする。また、$\mathcal{R} \subseteq \mathcal{P}(\prod_{x\in X} D(x))$ とする。このとき、3つ組 $\langle X, D, \mathcal{R} \rangle$ を**リレーションスキーマ**という。

$R\in \mathcal{R}$ はテーブルであり、とくにリレーションスキーマ $\langle X, D, \mathcal{R} \rangle$ の**インスタンス**と呼ぶ。
$\mathcal{R}$ はインスタンスの制約を表している。

---

テーブル（リレーション）が実際のデータなのに対して、リレーションスキーマはテーブルの設計に相当する。


# 関数従属性

## 関数従属性の定義
---
**定義3 (テーブルに対する関数従属性)**
$\langle X, D, R \rangle$ をテーブルとする。
$\mathcal{P}(X)$ 上の二項関係 $\to_R$ を次のように定義する。
すなわち、$A, B \in \mathcal{P}(X)$ に対して、$A \to_R B$ であることを
「$t_1, t_2\in R$ に対して $t_1[A] = t_2[A]$ ならば $t_1[B] = t_2[B]$」
と定義する。
$A\to_R B$ が成り立つことを「（テーブル $\langle X, D, R \rangle$ において）$B$ は $A$ に**関数従属**する」という。
$A\to_R B$ が成り立たないことを $A \not\to_R B$ と書くことにする。

---

「任意の $t_1, t_2\in R$ に対して $t_1[A] = t_2[A]$ ならば $t_1[B] = t_2[B]$」
であるというのは、「ある関数 $f$ が存在して、任意の $t\in R$ に対して $f(t[A]) = t[B]$ が成り立つ」ということである。

関数従属性の例をあげる。以下の「学生の所属する部活動と所属年数」のテーブル $\langle X, D, R \rangle$ を考える。

| 学籍番号 | 学生氏名 | 部活動  | 所属年数 |
| -------- | -------- | ------- | -------- |
| 1        | 学生A    | 部活動X | 1        |
| 1        | 学生A    | 部活動Y | 2        |
| 2        | 学生B    | 部活動X | 2        |
| 3        | 学生C    | 部活動Y | 1        |

このテーブルにおいて、以下の関数従属性が成り立つ。

* $\{学籍番号\}\to_R\{学生氏名\}$
* $\{学籍番号, 部活動\}\to_R\{所属年数\}$

また、このテーブルでは同姓同名がいないため、$\{学生氏名\}\to_R\{学籍番号\}$ が「たまたま」成り立っている。

---
**定義4 (リレーションスキーマに対する関数従属性)**
$\langle X, D, \mathcal{R} \rangle$ をリレーションスキーマとする。$\mathcal{P}(X)$ 上の二項関係 $\to_\mathcal{R}$ を次のように定義する。
すなわち、$A, B \in \mathcal{P}(X)$ に対して、$A \to_\mathcal{R} B$ であることを
「任意の $R\in \mathcal{R}$ に対して $A \to_R B$ である」
と定義する。

$A\to_\mathcal{R} B$ が成り立つことを「（リレーションスキーマ $\langle X, D, \mathcal{R} \rangle$ において）$B$ は $A$ に**関数従属**する」という。
$A\to_\mathcal{R} B$ が成り立たないことを $A \not\to_\mathcal{R} B$ と書くことにする。

誤解の恐れがなければ、$\to_\mathcal{R}$ を単に $\to$ と書く。

---

ここで、リレーションスキーマと関数従属性の例をあげる。
以下のテーブルをインスタンスに持つようなリレーションスキーマを定義する。

| 学籍番号 | 学生氏名 | 部活動  | 所属年数 |
| -------- | -------- | ------- | -------- |
| 1        | 学生A    | 部活動X | 1        |
| 1        | 学生A    | 部活動Y | 2        |
| 2        | 学生B    | 部活動X | 2        |
| 3        | 学生C    | 部活動Y | 1        |

$X=\{学籍番号, 学生氏名, 部活動, 所属年数\}$ とする。
集合族 $D=(D(x))_{x\in X}$ を次のように定める。
すなわち $D(学籍番号), D(所属年数)$ を整数の集合、$D(学生氏名), D(部活動)$ を文字列の集合とする。
次に、インスタンスの制約 $\mathcal{R} \subseteq \mathcal{P}(\prod_{x\in X} D(x))$ を定める。兼部や同姓同名の可能性を考慮して次のように定義する。
$$\mathcal{R} = \left\{R \in \mathcal{P}\left(\prod_{x\in X} D(x)\right) \mathrel{}\middle|\mathrel{} \begin{align*}\{学籍番号\}&\to_R\{学生氏名\} \\  \{学籍番号, 部活動\}&\to_R \{所属年数\}\end{align*} \right\}$$

このとき、$\langle X, D, \mathcal{R} \rangle$ は上記のテーブルをインスタンスとして持つリレーションスキーマである。
また、このリレーションスキーマについて、以下の関数従属性が成り立つ。

* $\{学籍番号\}\to_\mathcal{R}\{学生氏名\}$
* $\{学籍番号, 部活動\}\to_\mathcal{R} \{所属年数\}$

また、以下のような関数従属性は成り立たない（以下の関数従属性が成り立たないようなインスタンスが作成できるため）。

* $\{学籍番号\}\to_\mathcal{R}\{部活動\}$
* $\{学籍番号\}\to_\mathcal{R}\{学生氏名\}$

## 関数従属性の性質
$X$ を属性全体の集合として持つテーブルまたはリレーションスキーマの関数従属性を表す $\mathcal{P}(X)$ 上の二項関係 $\to$ について以下の性質が成り立つ。

* $A,B\in \mathcal{P}(X)$ に対して、$A\supseteq B$ ならば $A\to B$
**TODO: 後で書く**


## 完全関数従属
以下、関数従属性はリレーションスキーマに対する関数従属性のみを扱うことにする。
また $\to_\mathcal{R}$ を単に $\to$ と書くことにする。

---
**定義5 (完全関数従属性)**
$\langle X, D, \mathcal{R} \rangle$ をリレーションスキーマとする。
$A, B \in \mathcal{P}(X)$ に対して、$A\to B$ を満たし^[$A$ が $\{A' \in \mathcal{P}(X) \mid A'\to B\}$ の極小元ならば $A\to B$ を満たすので、$A\to B$という条件は冗長である。]、 $A$ が $\{A' \in \mathcal{P}(X) \mid A'\to B\}$ の極小元であるとき、$B$ は $A$ に**完全関数従属**するという。
関数従属するが完全関数従属しない場合は**部分関数従属**するという。

---

$\{A' \in \mathcal{P}(X) \mid A'\to B\}$ の極小元は必ず存在する。なぜならば、$X \to B$ が成り立つ、つまり$\{A' \in \mathcal{P}(X) \mid A'\to B\} \neq \emptyset$ が成り立つからである。

**TODO: これ本当にそう？（Zornの補題とかは関係ない？）**
**TODO: キーのところでこの話をする。**

**TODO: Xが有限じゃないと言えない。無限だと反例がある（正則関数のテーブル）**

## キー

# 正規形
## 2NF

## 3NF

# 本題(2NF, 3NFの証明)